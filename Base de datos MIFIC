Create database DbMificsql;
USE DbMificsql

CREATE SCHEMA perfil;

CREATE SCHEMA archivo

CREATE TABLE perfil.Notificaciones (
   IdNotificacion int primary key identity (1,1) not null ,
	 IdUsuario int not null , 
	 ContenidoNotificacion varchar (40) not null ,
	 Estado bit Not null , 
   UsuarioCreacion varchar(50) DEFAULT HOST_NAME(), 
	 FechaCreacion DATETIME DEFAULT GETDATE(),
   UsuarioEdicion varchar (50) DEFAULT NULL, 
	 FechaEdicion DATETIME DEFAULT NULL
	 CONSTRAINT fk_Id_Usuario FOREIGN KEY (IdUsuario) REFERENCES perfil.Usuario (IdUsuario) ON DELETE CASCADE ON UPDATE CASCADE

)

CREATE TABLE perfil.Entidad	(
	IdEntidad int PRIMARY KEY IDENTITY(1,1) NOT NULL,
	NombreEntidad varchar(30) NOT NULL UNIQUE, 
	UsuarioCreacion varchar(50) DEFAULT HOST_NAME(), 
	FechaCreacion DATETIME DEFAULT GETDATE(),
	UsuarioEdicion varchar (50) DEFAULT NULL, 
	FechaEdicion DATETIME DEFAULT NULL
)
GO

CREATE TRIGGER trg_UpdateEntidad
ON perfil.Entidad 
AFTER UPDATE
AS
BEGIN
    -- Actualice las columnas UsuarioEdicion y FechaEdicion para cada fila actualizada
    UPDATE t
    SET UsuarioEdicion = HOST_NAME(), FechaEdicion = GETDATE()
    FROM perfil.Entidad t 
    JOIN inserted i ON i.IdEntidad = t.IdEntidad 
END

CREATE TABLE perfil.Usuario(
	IdUsuario int PRIMARY KEY IDENTITY(1,1) NOT NULL, 
	IdEntidad int not null,
	IdRol INT NOT NULL, 
	NombreCompleto varchar(50) NOT NULL, 
	Usuario varchar(50) NOT NULL UNIQUE, 
	Contraseña varbinary(32) NOT NULL, 
	Estado bit NOT NULL,
	UsuarioCreacion varchar(50) DEFAULT HOST_NAME(), 
	FechaCreacion DATETIME DEFAULT GETDATE(),
	UsuarioEdicion varchar (50) DEFAULT NULL, 
	FechaEdicion DATETIME DEFAULT NULL

	CONSTRAINT fk_Id_Entidad FOREIGN KEY (IdEntidad) REFERENCES perfil.Entidad (IdEntidad) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT fk_Id_Rol FOREIGN KEY (IdRol) REFERENCES perfil.Rol (IdRol) ON DELETE NO ACTION ON UPDATE NO ACTION 
)
GO 

CREATE TRIGGER trg_UpdateUsuario
ON perfil.Usuario -- Replace with your table name
AFTER UPDATE
AS
BEGIN
    -- Update the UsuarioEdicion and FechaEdicion columns for each updated row
    UPDATE t
    SET UsuarioEdicion = HOST_NAME(), FechaEdicion = GETDATE()
    FROM perfil.Usuario t -- Replace with your table name
    JOIN inserted i ON i.IdUsuario = t.IdUsuario -- Replace with your primary key column
END


CREATE TABLE perfil.Rol (
	IdRol INT PRIMARY KEY IDENTITY (1,1) NOT NULL, 
	NombreRol VARCHAR(50) NOT NULL UNIQUE, 
	Estado BIT DEFAULT 0, 
	UsuarioCreacion varchar(50) DEFAULT HOST_NAME(), 
	FechaCreacion DATETIME DEFAULT GETDATE(),
	UsuarioEdicion varchar (50) DEFAULT HOST_NAME(), 
	FechaEdicion DATETIME DEFAULT GETDATE(),
)
GO

CREATE TRIGGER trg_UpdateRol
ON perfil.Rol 
AFTER UPDATE
AS
BEGIN

    UPDATE t
    SET UsuarioEdicion = HOST_NAME(), FechaEdicion = GETDATE()
    FROM perfil.Rol t 
    JOIN inserted i ON i.IdRol = t.IdRol 
END

CREATE TABLE perfil.RegistroUsuario(
	IdRegistro int PRIMARY KEY IDENTITY(1,1) NOT NULL,
	IdUsuario int NOT NULL, 
	IdDocumento int NOT NULL, 
	IdReporte int NOT NULL,
	NombreRegistro varchar(30) NOT NULL, 
	FechaIngreso DateTime  NOT NULL DEFAULT current_timestamp,
	FechaSalida	Datetime2  NOT NULL DEFAULT current_timestamp,
	UsuarioCreacion varchar(50) DEFAULT HOST_NAME(), 
	FechaCreacion DATETIME DEFAULT GETDATE(),
	UsuarioEdicion varchar (50) DEFAULT NULL, 
	FechaEdicion DATETIME DEFAULT NULL,
	CONSTRAINT fk_id_reporte FOREIGN KEY (IdReporte) REFERENCES perfil.Reporte (IdReporte) ON DELETE NO ACTION ON UPDATE NO ACTION, 
	CONSTRAINT fk_id_fk_usuario FOREIGN KEY (IdUsuario) REFERENCES perfil.Usuario(IdUsuario) ON DELETE NO ACTION ON UPDATE NO ACTION ,
	CONSTRAINT fk_id_documento FOREIGN KEY (IdDocumento) REFERENCES archivo.Documento (IdDocumento) ON DELETE CASCADE ON UPDATE CASCADE

)
GO 

CREATE TRIGGER trg_UpdateRegistroUsuario
ON perfil.RegistroUsuario
AFTER UPDATE
AS
BEGIN

    UPDATE t
    SET UsuarioEdicion = HOST_NAME(), FechaEdicion = GETDATE()
    FROM archivo.RegistroUsuario t 
    JOIN inserted i ON i.IdRegistro = t.IdRegistro
END


CREATE TABLE perfil.Reporte(
	IdReporte INT PRIMARY KEY IDENTITY (1,1) NOT NULL, 
	IdDocumento INT NOT NULL,
	IdDocHistorial INT NOT NULL,
	NombreReporte VARCHAR(50) NOT NULL,
	FechaReporte DATETIME DEFAULT GETDATE(),
	UsuarioCreacion varchar(50) DEFAULT HOST_NAME(), 
	FechaCreacion DATETIME DEFAULT GETDATE(),
	UsuarioEdicion varchar (50) DEFAULT NULL, 
	FechaEdicion DATETIME DEFAULT NULL,
	CONSTRAINT ck_idusuario FOREIGN KEY (IdDocumento) REFERENCES archivo.Documento(IdDocumento),
	CONSTRAINT ck_idDocHistorial FOREIGN KEY (IdDocHistorial) REFERENCES archivo.DocumentoHistorial(IdDocHistorial) ON DELETE CASCADE ON UPDATE CASCADE
)
GO


CREATE TRIGGER trg_UpdateReporte
ON perfil.Reporte 
AFTER UPDATE
AS
BEGIN

    UPDATE t
    SET UsuarioEdicion = HOST_NAME(), FechaEdicion = GETDATE()
    FROM perfil.Reporte t 
    JOIN inserted i ON i.IdReporte = t.IdReporte 
END

CREATE TABLE archivo.Categoria
(
	IdCategoria INT PRIMARY KEY IDENTITY(1,1) NOT NULL, 
	NombreCategoria VARCHAR(50) not NULL UNIQUE,
	UsuarioCreacion varchar(50) DEFAULT HOST_NAME(), 
	FechaCreacion DATETIME DEFAULT GETDATE(),
	UsuarioEdicion varchar (50) DEFAULT NULL, 
	FechaEdicion DATETIME DEFAULT NULL
)
GO

CREATE TRIGGER trg_UpdateCategoria
ON archivo.Categoria 
AFTER UPDATE
AS
BEGIN

    UPDATE t
    SET UsuarioEdicion = HOST_NAME(), FechaEdicion = GETDATE()
    FROM archivo.Categoria t 
    JOIN inserted i ON i.IdCategoria = t.IdCategoria
END

CREATE TABLE archivo.Documento(
	IdDocumento INT PRIMARY KEY IDENTITY(1,1) NOT NULL, 
	IdCategoria INT NOT NULL,
	NombreDocumento varchar(50) not null, 
	Extension varchar(30) NOT NULL, 
	FechaSubida DATETIME DEFAULT GETDATE(),
	FechaExpiracion DATETIME NOT NULL, 
	NivelSeguridad INT NOT NULL, 
	UsuarioCreacion varchar(50) DEFAULT HOST_NAME(), 
	FechaCreacion DATETIME DEFAULT GETDATE(),
	UsuarioEdicion varchar (50) DEFAULT NULL, 
	FechaEdicion DATETIME DEFAULT NULL
	CONSTRAINT fk_id_Categoria FOREIGN KEY (idCategoria) REFERENCES archivo.Categoria (IdCategoria) ON DELETE CASCADE ON UPDATE CASCADE
)
GO

CREATE TRIGGER trg_UpdateDocumento
ON archivo.Documento
AFTER UPDATE
AS
BEGIN

    UPDATE t
    SET UsuarioEdicion = HOST_NAME(), FechaEdicion = GETDATE()
    FROM archivo.Documento t 
    JOIN inserted i ON i.IdDocumento = t.IdDocumento
END


CREATE TABLE archivo.Permisos(
	IdPermiso INT PRIMARY KEY IDENTITY (1,1),
	IdRol INT NOT NULL, 
	Leer bit NOT NULL,
	Copiar bit NOT NULL,
	Descargar bit NOT NULL,
	Imprimir bit NOT NULL,
	DejarCompartir bit NOT NULL,
	Comentar bit NOT NULL,
	UsuarioCreacion varchar(50) DEFAULT HOST_NAME(), 
	FechaCreacion DATETIME DEFAULT GETDATE(),
	UsuarioEdicion varchar (50) DEFAULT NULL, 
	FechaEdicion DATETIME DEFAULT NULL,
	CONSTRAINT fk_IdRole FOREIGN KEY (IdRol) REFERENCES perfil.Rol (IdRol) ON DELETE CASCADE ON UPDATE CASCADE
)
GO

CREATE TRIGGER trg_UpdatePermisos
ON archivo.Permisos
AFTER UPDATE
AS
BEGIN

    UPDATE t
    SET UsuarioEdicion = HOST_NAME(), FechaEdicion = GETDATE()
    FROM archivo.Permisos t 
    JOIN inserted i ON i.IdPermiso = t.IdPermiso
END

CREATE TRIGGER InsertedRole
ON perfil.Rol
AFTER INSERT
AS
BEGIN
    SET NOCOUNT ON;

    INSERT INTO archivo.Permisos (IdRol, Leer, Copiar, Descargar, Imprimir, DejarCompartir, Comentar)
    SELECT IdRol,
        CASE
            WHEN NombreRol = 'Administrador' OR NombreRol = 'Basico' OR NombreRol = 'Intermedio' OR NombreRol = 'Avanzado' THEN 1
            ELSE 0
        END,
        CASE
            WHEN NombreRol = 'Administrador' OR NombreRol = 'Intermedio' OR NombreRol = 'Avanzado' THEN 1
            ELSE 0
        END,
        CASE
            WHEN NombreRol = 'Administrador' OR NombreRol = 'Avanzado' THEN 1
            ELSE 0
        END,
        CASE
            WHEN NombreRol = 'Administrador' THEN 1
            ELSE 0
        END,
        CASE
            WHEN NombreRol = 'Administrador' THEN 1
            ELSE 0
        END,
        CASE
            WHEN NombreRol = 'Administrador' THEN 1
            ELSE 0
        END
    FROM inserted;
END
GO


CREATE TABLE archivo.DocumentoProgramar(
	IdDocProgramar INT PRIMARY KEY IDENTITY (1,1),
	IdDocumento INT NOT NULL, 
	FechaSubida DATETIME DEFAULT GETDATE(), 
	FechaExpiracion DATETIME NOT NULL,
	TiempoRestante INT NOT NULL,
	UsuarioCreacion varchar(50) DEFAULT HOST_NAME(), 
	FechaCreacion DATETIME DEFAULT GETDATE(),
	UsuarioEdicion varchar (50) DEFAULT NULL, 
	FechaEdicion DATETIME DEFAULT NULL,
	CONSTRAINT fk_Id_Documento FOREIGN KEY (IdDocumento) REFERENCES archivo.Documento (IdDocumento) ON DELETE CASCADE ON UPDATE CASCADE,
	CONSTRAINT CK_Fecha_Expira CHECK (TiempoRestante >=0 ) 

)
GO 

CREATE TRIGGER trg_UpdateDocumentoProgramar
ON archivo.DocumentoProgramar
AFTER UPDATE
AS
BEGIN
    UPDATE t
    SET UsuarioEdicion = HOST_NAME(), FechaEdicion = GETDATE()
    FROM archivo.DocumentoProgramar t 
    JOIN inserted i ON i.IdDocProgramar = t.IdDocProgramar
END


CREATE TRIGGER trg_ProgramarDocumento
ON archivo.documento
AFTER INSERT, UPDATE
AS 
BEGIN 
	IF EXISTS (SELECT * FROM INSERTED)
	BEGIN 
		DECLARE @IdDocumento INT, @FechaSubida DATETIME, @FechaExpiracion DATETIME, @TiempoRestante INT
		
		SELECT @IdDocumento = IdDocumento, @FechaSubida = FechaSubida, @FechaExpiracion = FechaExpiracion
		FROM INSERTED

		SET @TiempoRestante = CAST( DATEDIFF (DAY, GETDATE(), @FechaExpiracion) AS INT)


		INSERT INTO archivo.DocumentoProgramar (IdDocumento, FechaExpiracion, TiempoRestante)
		VALUES (@IdDocumento, @FechaExpiracion, @TiempoRestante)
	END
END 

CREATE TABLE archivo.DocumentoHistorial(
	IdDocHistorial INT PRIMARY KEY IDENTITY (1,1), 
	IdDocumento INT NOT NULL, 
	FechaCambio DATETIME NOT NULL, 
	TipoCambio VARCHAR(50) NOT NULL, 
	UsuarioCambio VARCHAR (50) NOT NULL,
	UsuarioCreacion varchar(50) DEFAULT HOST_NAME(), 
	FechaCreacion DATETIME DEFAULT GETDATE(),
	UsuarioEdicion varchar (50) DEFAULT NULL, 
	FechaEdicion DATETIME DEFAULT NULL,
)
GO

CREATE TABLE archivo.Confidencialidad(
    Idconfidencialidad int primary key identity (1 , 1 ), 
	IdUsuario int NOT NULL,
	IdDocumento int Not NULL ,
	UsuarioCreacion varchar(50) DEFAULT HOST_NAME(), 
	FechaCreacion DATETIME DEFAULT GETDATE(),
	UsuarioEdicion varchar (50) DEFAULT NULL, 
	FechaEdicion DATETIME DEFAULT NULL,
	CONSTRAINT fk_id_fk_Documento FOREIGN KEY (IdDocumento) REFERENCES archivo.Documento(IdDocumento) ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT FK_id_fk_Usuario FOREIGN KEY (IdUsuario) REFERENCES perfil.Usuario (IdUsuario) ON DELETE CASCADE ON UPDATE CASCADE) 
	GO 


 CREATE TRIGGER trg_confidencialidad
 on archivo.confidencialidad
FOR INSERT, UPDATE
AS
BEGIN
  DECLARE @IdDocumento INT, @IdUsuario INT, @NivelConfidencialidad VARCHAR(50);

  SELECT @IdDocumento = IdDocumento FROM inserted;

  -- Obtener información del usuario actual (debe existir una tabla de usuarios)
  SET @IdUsuario = (SELECT @IdUsuario FROM perfil.Usuario WHERE NombreCompleto = SYSTEM_USER);

  -- Obtener nivel de confidencialidad del documento (debe existir una columna NivelConfidencialidad en Documentos)
  SET @NivelConfidencialidad = (SELECT @NivelConfidencialidad FROM archivo.Documento WHERE @IdDocumento = @IdDocumento);

  -- Insertar registro en tabla de confidencialidad
  INSERT INTO Confidencialidad (IdDocumento,Confidencialidad, FechaAcceso, IdUsuario)
  VALUES (@IdDocumento, @NivelConfidencialidad, GETDATE(), @IdUsuario);

  -- Implementar control de acceso basado en el nivel de confidencialidad
  IF @NivelConfidencialidad = 'Restringido'
  BEGIN
    -- Aquí puedes realizar acciones adicionales, como lanzar una excepción o denegar el acceso a la actualización o inserción
    RAISERROR ('No tienes permisos para acceder a este documento.', 16, 1);
    ROLLBACK;
  END
END;



CREATE TRIGGER trg_UpdateDocumentoHistorial
ON archivo.DocumentoHistorial
AFTER UPDATE
AS
BEGIN

    UPDATE t
    SET UsuarioEdicion = HOST_NAME(), FechaEdicion = GETDATE()
    FROM archivo.DocumentoHistorial t 
    JOIN inserted i ON i.IdDocHistorial = t.IdDocHistorial
END


CREATE TRIGGER trg_CambiosDocumentos
ON archivo.Documento
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
   DECLARE @TipoCambio VARCHAR(50)

   IF EXISTS(SELECT * FROM inserted) AND EXISTS(SELECT * FROM deleted)
      SET @TipoCambio = 'Modificado'
   ELSE IF EXISTS(SELECT * FROM inserted)
      SET @TipoCambio = 'Creado'
   ELSE IF EXISTS(SELECT * FROM deleted)
      SET @TipoCambio = 'Eliminado'

   IF @TipoCambio IS NOT NULL
   BEGIN
      INSERT INTO archivo.DocumentoHistorial (IdDocumento, FechaCambio, TipoCambio, UsuarioCambio)
      SELECT 
         COALESCE(i.IdDocumento, d.IdDocumento) AS IdDocumento,
         GETDATE() AS FechaCambio,
         @TipoCambio AS TipoCambio,
         HOST_NAME() AS UsuarioCambio
      FROM inserted i
      FULL OUTER JOIN deleted d ON i.IdDocumento = d.IdDocumento
   END
END


SELECT * FROM archivo.DocumentoHistorial
SELECT * FROM archivo.DocumentoProgramar
SELECT * FROM archivo.Permisos


INSERT INTO archivo.Categoria (NombreCategoria) Values ('Politica')
INSERT INTO archivo.Categoria (NombreCategoria) Values ('Educacion')
INSERT INTO archivo.Categoria (NombreCategoria) Values ('Ambiental')
INSERT INTO archivo.Categoria (NombreCategoria) Values ('Social')
SELECT * FROM archivo.Categoria


INSERT INTO archivo.Documento (IdCategoria, NombreDocumento, Extension,FechaExpiracion, NivelSeguridad) VALUES (1, 'Acuerdos Internacionales', 'pdf','2028-05-26',1)
INSERT INTO archivo.Documento (IdCategoria, NombreDocumento, Extension,FechaExpiracion, NivelSeguridad) VALUES (2, 'Educacion vial', 'pdf','2028-05-26',1)
SELECT * FROM archivo.Documento


INSERT INTO perfil.Entidad (NombreEntidad) Values ('OMS')
SELECT * FROM perfil.Entidad


INSERT INTO perfil.rol (NombreRol, Estado) VALUES ('Administrador', 1)
INSERT INTO perfil.rol (NombreRol, Estado) VALUES ('Basico', 1)
INSERT INTO perfil.rol (NombreRol, Estado) VALUES ('Intermedio', 1)
INSERT INTO perfil.rol (NombreRol, Estado) VALUES ('Avanzado', 1)
SELECT * FROM perfil.Rol


INSERT INTO perfil.Usuario (IdEntidad, IdRol, NombreCompleto, Usuario, Contraseña, Estado) VALUES (1, 1, 'Maria Davila', 'lourdav', 15623, 1)
INSERT INTO perfil.Usuario (IdEntidad, IdRol, NombreCompleto, Usuario, Contraseña, Estado) VALUES (1, 2, 'Edmundo Sanchez', 'edsan', 553597, 1)
SELECT * FROM perfil.Usuario


INSERT INTO perfil.Reporte (IdDocumento, IdDocHistorial, NombreReporte) VALUES (1,1, 'Reporte1')
SELECT * FROM perfil.Reporte


INSERT INTO perfil.RegistroUsuario (IdUsuario, IdDocumento, IdReporte, NombreRegistro) VALUES ( 1, 1, 1, 'Registro 1')
SELECT * FROM perfil.RegistroUsuario
